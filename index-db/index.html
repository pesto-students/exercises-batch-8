<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="shortcut icon"
      href="https://www.pesto.tech/assets/favicon.ico"
    />
    <title>Document</title>
  </head>

  <body>
    <h1 class="heading">indexedDB Editor</h1>

    <form>
      Key:
      <input type="text" name="firstname" class="input" id="key" /> Value:
      <input type="text" name="lastname" class="input" id="value" />

      <input
        type="button"
        onclick="saveToIndexedDb()"
        value="Submit"
        class="btn"
      />
    </form>
    <div style="display:flex; align-items: center;justify-content: center;">
      <ul id="listOfStoredItems"></ul>
    </div>
    <script>
      let db;
      let dbReq = indexedDB.open('someDB', 1);
      dbReq.onupgradeneeded = event => {
        db = event.target.result;
        db.createObjectStore('todo', { autoIncrement: true });
        updateList();
      };
      dbReq.onsuccess = event => {
        db = event.target.result;
        updateList();
      };
      dbReq.onerror = () => {
        alert('Error while setting up indexed db');
      };
      const updateList = () => {
        let tx = db.transaction(['todo'], 'readwrite');
        let store = tx.objectStore('todo');
        const cursorReq = store.openCursor();
        const todos = [];
        document.getElementById('listOfStoredItems').innerHTML = '';
        cursorReq.onsuccess = event => {
          let cursor = event.target.result;
          if (cursor) {
            const key = cursor.primaryKey;
            const value = cursor.value;
            document.getElementById(
              'listOfStoredItems'
            ).innerHTML += `<li style="min-width: 150px;position: relative;">${
              value.key
            } - ${
              value.value
            } <button style="right: 0; position: absolute;" onclick="deleteItem('${key}')">x</button></li>`;
            cursor.continue();
          }
        };
      };
      const saveToIndexedDb = () => {
        let tx = db.transaction(['todo'], 'readwrite');
        let store = tx.objectStore('todo');
        const key = document.getElementById('key').value;
        const value = document.getElementById('value').value;
        let todoInstance = { key, value };
        store.add(todoInstance);
        tx.oncomplete = () => {
          updateList();
          document.getElementById('key').value = '';
          document.getElementById('value').value = '';
        };
        tx.onerror = () => {
          alert('Error occurred while adding item to db');
        };
      };
      const deleteItem = key => {
        let tx = db.transaction(['todo'], 'readwrite');
        let store = tx.objectStore('todo');
        const deleteReq = store.delete(Number(key));
        deleteReq.onsuccess = () => {
          updateList();
        };
        deleteReq.onerror = () => {
          alert.log('error while deleting');
        };
      };
      document.addEventListener('keypress', function(e) {
        var key = e.which || e.keyCode;
        if (key === 13) {
          saveToIndexedDb();
        }
      });
    </script>
  </body>
</html>
